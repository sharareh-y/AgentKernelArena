source_file_path:
  - source/triton_apply_grammar_bitmask.py

target_kernel_functions:
  - _apply_grammar_bitmask_kernel

compile_command:
  - python3 scripts/task_runner.py compile

correctness_command:
  - python3 scripts/task_runner.py correctness

performance_command:
  - python3 scripts/task_runner.py performance

task_type: triton2triton

task_result_template: null

prompt:
  source_code: null
  instructions: |
    Optimize the Triton kernel `_apply_grammar_bitmask_kernel` for maximum GPU throughput
    while maintaining correctness.

    The kernel applies a packed grammar bitmask to logits for structured output generation.
    The bitmask is stored as int32 values where each int32 encodes 32 bits. The kernel
    unpacks the bitmask using bit shifting and sets logits to -inf where the bit is 0
    (token not allowed by grammar).

    The 2D grid is (num_masks, num_vocab_blocks) where num_vocab_blocks = ceil(vocab_size / BLOCK_SIZE).

    Key optimization opportunities:
    - Block size tuning
    - Efficient bitmask unpacking
    - Vectorized stores for masked positions
    - Memory coalescing

    Constraints:
    - Must maintain the same function signature for `apply_grammar_bitmask`
    - Bitmask format: int32 packed, bit 0 = disallowed (set to -inf), bit 1 = allowed
    - Output must match reference (exact -inf placement, unchanged non-masked values)
  cheatsheet: null
